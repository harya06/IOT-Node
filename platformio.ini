; ==================================================================================
; ESP32 IoT Node - Dual Firmware + SD Card Support
; Version: v3.0.0
; ==================================================================================

[platformio]
default_envs = esp32dev-wifi

; ==================================================================================
; COMMON ENVIRONMENT SETTINGS
; ==================================================================================
[env]
platform = espressif32@6.9.0
board = esp32dev
framework = arduino

; Serial Monitor Settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, colorize

; Upload Settings
upload_speed = 460800
upload_resetmethod = nodemcu
monitor_rts = 0
monitor_dtr = 0

; Partition & Filesystem
board_build.partitions = default.csv
board_build.filesystem = littlefs

; Common Build Flags
build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DMQTT_MAX_PACKET_SIZE=1024
    -DMQTT_KEEPALIVE=60
    -DMQTT_SOCKET_TIMEOUT=15
    -DARDUINOJSON_USE_LONG_LONG=1
    -DCONNECT_TIMEOUT=15000
    -DAP_TIMEOUT=150000
    -Wall
    -Wno-deprecated-declarations

; Common Libraries (termasuk SD Card)
lib_deps = 
    bblanchon/ArduinoJson@^6.21.4
    knolleary/PubSubClient@^2.8.0
    robtillaart/PCF8574@^0.4.2
    greiman/SdFat@^2.2.2
    SD                          ; ✅ SD Card Library (built-in ESP32)
    SPI                         ; ✅ SPI untuk SD Card & Ethernet
    FS                          ; ✅ File System
    LittleFS                    ; ✅ LittleFS

; Libraries to ignore
lib_ignore = 
    WebSockets_Generic
    WiFiEspAT
    WiFi101
    WiFiNINA
    WiFi101_Generic
    WiFiNINA_Generic
    WiFiWebServer
    EthernetWebServer
    Ethernet_Generic
    Seeed_Arduino_rpcWiFi
    Seeed_Arduino_rpcUnified
    WiFiManager

; ==================================================================================
; WIFI FIRMWARE (Serial Upload)
; ==================================================================================
[env:esp32dev-wifi]
upload_port = COM3
upload_protocol = esptool

upload_flags = 
    --before=default_reset
    --after=hard_reset
    --connect-attempts=5

build_flags = 
    ${env.build_flags}
    -DWEBSOCKETS_NETWORK_TYPE=NETWORK_ESP32
    -DFIRMWARE_WIFI_ONLY=1
    -DVERSION_STRING=\"v3.0.0-WiFi\"

lib_deps = 
    ${env.lib_deps}
    links2004/WebSockets@^2.5.1

lib_ignore = 
    ${env.lib_ignore}
    Ethernet

; ==================================================================================
; WIFI FIRMWARE (OTA Upload)
; ==================================================================================
[env:esp32dev-wifi-ota]
upload_protocol = espota
upload_port = 192.168.0.123     ; ⚠️ Sesuaikan dengan IP ESP32 Anda
upload_flags = 
    --port=3232
    --auth=password

build_flags = 
    ${env.build_flags}
    -DWEBSOCKETS_NETWORK_TYPE=NETWORK_ESP32
    -DFIRMWARE_WIFI_ONLY=1
    -DVERSION_STRING=\"v3.0.0-WiFi-OTA\"

lib_deps = 
    ${env.lib_deps}
    links2004/WebSockets@^2.5.1

lib_ignore = 
    ${env.lib_ignore}
    Ethernet

; ==================================================================================
; ETHERNET FIRMWARE (Serial Upload)
; ==================================================================================
[env:esp32dev-ethernet]
upload_port = COM3
upload_protocol = esptool

upload_flags = 
    --before=default_reset
    --after=hard_reset
    --connect-attempts=5

build_flags = 
    ${env.build_flags}
    -DFIRMWARE_ETHERNET_ONLY=1
    -DVERSION_STRING=\"v3.0.0-Ethernet\"

lib_deps = 
    ${env.lib_deps}
    arduino-libraries/Ethernet@^2.0.2

lib_ignore = 
    ${env.lib_ignore}
    WebSockets

; ==================================================================================
; DEBUG ENVIRONMENT - WiFi (Verbose Logging)
; ==================================================================================
[env:esp32dev-wifi-debug]
extends = env:esp32dev-wifi
build_type = debug

build_flags = 
    ${env:esp32dev-wifi.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE
    -DDEBUG_ESP_WIFI

monitor_filters = 
    esp32_exception_decoder
    colorize
    time

; ==================================================================================
; DEBUG ENVIRONMENT - Ethernet (Verbose Logging)
; ==================================================================================
[env:esp32dev-ethernet-debug]
extends = env:esp32dev-ethernet
build_type = debug

build_flags = 
    ${env:esp32dev-ethernet.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_CORE

monitor_filters = 
    esp32_exception_decoder
    colorize
    time

; ==================================================================================
; SAFE MODE - WiFi (Ultra-safe upload settings)
; ==================================================================================
[env:esp32dev-wifi-safe]
upload_port = COM3
upload_protocol = esptool

; Ultra-safe upload settings
upload_speed = 115200
upload_resetmethod = nodemcu
upload_flags = 
    --before=default_reset
    --after=hard_reset
    --connect-attempts=10
    
monitor_rts = 0
monitor_dtr = 0

build_flags = 
    ${env.build_flags}
    -DWEBSOCKETS_NETWORK_TYPE=NETWORK_ESP32
    -DFIRMWARE_WIFI_ONLY=1
    -DVERSION_STRING=\"v3.0.0-WiFi-Safe\"

lib_deps = 
    ${env.lib_deps}
    links2004/WebSockets@^2.5.1

lib_ignore = 
    ${env.lib_ignore}
    Ethernet

; ==================================================================================
; PRODUCTION BUILD - WiFi (Optimized)
; ==================================================================================
[env:esp32dev-wifi-production]
extends = env:esp32dev-wifi
build_type = release

build_flags = 
    ${env:esp32dev-wifi.build_flags}
    -DCORE_DEBUG_LEVEL=0
    -Os
    -ffunction-sections
    -fdata-sections

build_unflags = 
    -DCORE_DEBUG_LEVEL=3

; ==================================================================================
; PRODUCTION BUILD - Ethernet (Optimized)
; ==================================================================================
[env:esp32dev-ethernet-production]
extends = env:esp32dev-ethernet
build_type = release

build_flags = 
    ${env:esp32dev-ethernet.build_flags}
    -DCORE_DEBUG_LEVEL=0
    -Os
    -ffunction-sections
    -fdata-sections

build_unflags = 
    -DCORE_DEBUG_LEVEL=3